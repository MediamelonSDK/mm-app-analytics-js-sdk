var MMAppAnalyticsSDK=function(e){"use strict";class t{constructor(e){if(!e||"object"!=typeof e)throw new Error("Configuration must be an object");if(!e.customerId)throw new Error("Customer ID is required");if(!e.appId)throw new Error("App ID is required");if(!e.appName)throw new Error("App Name is required");if(!e.appVersion)throw new Error("App Version is required");this._config={customerId:e.customerId,appId:e.appId,appName:e.appName,appVersion:e.appVersion,sdkVersion:"1.0.0",platform:"web",dataSrc:"Application",sessionId:this._generateUUID(),...e},this._initializeStaticMetadata()}_initializeStaticMetadata(){const e=navigator.userAgent,t=window.screen;/iPad|Android|Tablet/i.test(e)?this.setDeviceType("tablet"):/Mobile|Android|iPhone|iPod/i.test(e)?this.setDeviceType("mobile"):this.setDeviceType("desktop"),/Chrome/i.test(e)?(this.setBrowser("Chrome"),this.setBrowserVersion(e.match(/Chrome\/(\d+\.\d+\.\d+\.\d+)/)?.[1])):/Firefox/i.test(e)?(this.setBrowser("Firefox"),this.setBrowserVersion(e.match(/Firefox\/(\d+\.\d+)/)?.[1])):/Safari/i.test(e)&&!/Chrome/i.test(e)?(this.setBrowser("Safari"),this.setBrowserVersion(e.match(/Version\/(\d+\.\d+\.\d+)/)?.[1])):/Edge/i.test(e)&&(this.setBrowser("Edge"),this.setBrowserVersion(e.match(/Edge\/(\d+\.\d+\.\d+\.\d+)/)?.[1])),/Windows/i.test(e)?(this.setOS("Windows"),this.setOSVersion(e.match(/Windows NT (\d+\.\d+)/)?.[1])):/Mac OS X/i.test(e)?(this.setOS("MacOS"),this.setOSVersion(e.match(/Mac OS X (\d+[._]\d+)/)?.[1]?.replace("_","."))):/Linux/i.test(e)?(this.setOS("Linux"),this.setOSVersion("Unknown")):/Android/i.test(e)?(this.setOS("Android"),this.setOSVersion(e.match(/Android (\d+\.\d+)/)?.[1])):/iOS|iPhone|iPad|iPod/i.test(e)&&(this.setOS("iOS"),this.setOSVersion(e.match(/OS (\d+[._]\d+)/)?.[1]?.replace("_","."))),this.setScreenRes(`${t.width}x${t.height}`),this.setScreenWidth(t.width),this.setScreenHeight(t.height),this.setColorDepth(t.colorDepth),this.setPixelRatio(window.devicePixelRatio),this.setViewportWidth(window.innerWidth),this.setViewportHeight(window.innerHeight),this.setLanguage(navigator.language),this.setTimezone(Intl.DateTimeFormat().resolvedOptions().timeZone),this.setDeviceId(this._generateUUID()),this.setUserAgent(e)}setDeviceType(e){this._config.deviceType=e}setBrowser(e){this._config.browser=e}setBrowserVersion(e){this._config.browserVersion=e}setOS(e){this._config.os=e}setOSVersion(e){this._config.osVersion=e}setScreenRes(e){this._config.screenRes=e}setScreenWidth(e){this._config.screenWidth=e}setScreenHeight(e){this._config.screenHeight=e}setColorDepth(e){this._config.colorDepth=e}setPixelRatio(e){this._config.pixelRatio=e}setViewportWidth(e){this._config.viewportWidth=e}setViewportHeight(e){this._config.viewportHeight=e}setLanguage(e){this._config.language=e}setTimezone(e){this._config.timezone=e}setDeviceId(e){this._config.deviceId=e}setUserAgent(e){this._config.userAgent=e}_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}getEventMetadata(){return{deviceType:this._config.deviceType,browser:this._config.browser,browserVersion:this._config.browserVersion,os:this._config.os,osVersion:this._config.osVersion,screenRes:this._config.screenRes,screenWidth:this._config.screenWidth,screenHeight:this._config.screenHeight,colorDepth:this._config.colorDepth,pixelRatio:this._config.pixelRatio,viewportWidth:this._config.viewportWidth,viewportHeight:this._config.viewportHeight,language:this._config.language,timezone:this._config.timezone,deviceId:this._config.deviceId,userAgent:this._config.userAgent,timestamp:Date.now(),platform:this._config.platform,sdkVersion:this._config.sdkVersion,dataSrc:this._config.dataSrc}}get(e){return this._config[e]}set(e,t){this._config[e]=t}getConfig(){return{...this._config}}getDeviceInfo(){return{deviceType:this._config.deviceType,browser:this._config.browser,browserVersion:this._config.browserVersion,os:this._config.os,osVersion:this._config.osVersion,screenRes:this._config.screenRes,screenWidth:this._config.screenWidth,screenHeight:this._config.screenHeight,colorDepth:this._config.colorDepth,pixelRatio:this._config.pixelRatio,viewportWidth:this._config.viewportWidth,viewportHeight:this._config.viewportHeight,language:this._config.language,timezone:this._config.timezone,deviceId:this._config.deviceId,userAgent:this._config.userAgent}}getAppInfo(){return{customerId:this._config.customerId,appId:this._config.appId,appName:this._config.appName,appVersion:this._config.appVersion,platform:this._config.platform,sdkVersion:this._config.sdkVersion,dataSrc:this._config.dataSrc}}getSessionId(){return this._config.sessionId}updateSessionId(e){this._config.sessionId=e}}class r{constructor(){this._states={app:{current:{state:"foreground",timestamp:Date.now()},previous:null,history:[]},video:{current:{state:"idle",timestamp:Date.now()},previous:null,history:[]},screen:{current:null,previous:null,history:[]},user:{current:null,previous:null,history:[]},payment:{current:null,previous:null,history:[]},subscription:{current:null,previous:null,history:[]}},this._states.app.history.push(this._states.app.current),this._states.video.history.push(this._states.video.current),this._maxHistoryLength=10,this._stateChangeCallbacks=new Map}getAppState(){return this._states.app.current?.state||"foreground"}getVideoState(){return this._states.video.current?.state||"idle"}getScreenState(){return this._states.screen.current?.state||null}getVideoData(){return this._states.video.current?.metadata||null}getScreenData(){return this._states.screen.current?.metadata||null}getVideoStateHistory(){return this._states.video.history}getAppStateHistory(){return this._states.app.history}getScreenStateHistory(){return this._states.screen.history}updateAppState(e,t={}){return this._updateState("app",e,t)}updateVideoState(e,t={}){return this._updateState("video",e,t)}updateScreenState(e,t={}){return this._updateState("screen",e,t)}updateUserState(e){return this._updateState("user","identified",e)}getUserState(){return this._states.user.current}getUserStateHistory(){return this._states.user.history}getCurrentState(e){return this._states[e]?.current||null}getPreviousState(e){return this._states[e]?.previous||null}getStateHistory(e){return[...this._states[e]?.history||[]]}onStateChange(e,t){this._stateChangeCallbacks.has(e)||this._stateChangeCallbacks.set(e,new Set),this._stateChangeCallbacks.get(e).add(t)}offStateChange(e,t){const r=this._stateChangeCallbacks.get(e);r&&r.delete(t)}clearStates(){this._states={app:{current:{state:"foreground",timestamp:Date.now()},previous:null,history:[]},video:{current:{state:"idle",timestamp:Date.now()},previous:null,history:[]},screen:{current:null,previous:null,history:[]},user:{current:null,previous:null,history:[]},payment:{current:null,previous:null,history:[]},subscription:{current:null,previous:null,history:[]}}}_updateState(e,t,r){try{if(!this._states[e])throw new Error(`Invalid state type: ${e}`);if(!this._isValidStateTransition(e,t))return!1;const i={state:t,timestamp:Date.now(),metadata:r};return this._states[e].previous=this._states[e].current,this._states[e].current=i,this._states[e].history.push(i),this._states[e].history.length>this._maxHistoryLength&&this._states[e].history.shift(),this._notifyStateChange(e,i),!0}catch(t){return console.error(`State update failed for ${e}:`,t),!1}}_isValidStateTransition(e,t){const r=this._states[e].current?.state||null,i={app:{null:["foreground","background"],foreground:["background"],background:["foreground"]},video:{null:["idle","loading","playing"],idle:["loading","playing"],loading:["playing","error"],playing:["paused","ended","error"],paused:["playing","ended"],ended:["idle","loading"],error:["idle"]},screen:{null:["active"],active:["inactive"],inactive:["active"]},payment:{null:["initiated","processing"],initiated:["processing","failed"],processing:["success","failed","refunded"],success:["refunded"],failed:["initiated"],refunded:["initiated"]},subscription:{null:["trial","active"],trial:["active","expired"],active:["cancelled","expired","upgraded","downgraded"],cancelled:["active","expired"],expired:["active"],upgraded:["active"],downgraded:["active"]}}[e];return!!i&&(i[r]||[]).includes(t)}_notifyStateChange(e,t){const r=this._stateChangeCallbacks.get(e);r&&r.forEach((r=>{try{r(t,this._states[e].previous)}catch(t){console.error(`Error in state change callback for ${e}:`,t)}}))}updatePaymentState(e,t={}){return this._updateState("payment",e,t)}getPaymentState(){return this._states.payment.current}getPaymentStateHistory(){return this._states.payment.history}updateSubscriptionState(e,t={}){return this._updateState("subscription",e,t)}getSubscriptionState(){return this._states.subscription.current}getSubscriptionStateHistory(){return this._states.subscription.history}}const i={getItem(e){try{return localStorage.getItem(e)}catch(e){return console.error("Failed to get item from storage:",e),null}},setItem(e,t){try{return localStorage.setItem(e,t),!0}catch(e){return console.error("Failed to set item in storage:",e),!1}},removeItem(e){try{return localStorage.removeItem(e),!0}catch(e){return console.error("Failed to remove item from storage:",e),!1}}};class a{constructor(e={}){this._config={batchSize:e.batchSize||10,flushInterval:e.flushInterval||5e3,maxRetries:e.maxRetries||3,retryDelay:e.retryDelay||1e3,getConfig:()=>({batchSize:this._config.batchSize,flushInterval:this._config.flushInterval,maxRetries:this._config.maxRetries,retryDelay:this._config.retryDelay})},this.events=[],this._flushTimer=null,this._producerURL="https://streamproducer-lcrr.mediamelon.com",this._processingQueue=[],this._retryTimeouts=new Map,this._isProcessing=!1,this._stats={successfulEvents:0,failedEvents:0,totalProcessed:0,lastProcessTime:0},this._loadStoredEvents(),this._startFlushTimer(),this._config.getConfig()}setProducerURL(e){if(!e||"string"!=typeof e)throw new Error("Valid producer URL is required");this._producerURL=e}getProducerURL(){return this._producerURL}updateConfig(e){this._config={...e,getConfig:()=>e},this._flushTimer&&clearInterval(this._flushTimer),this._startFlushTimer()}_loadStoredEvents(){const e=i.getItem("mm_analytics_event_queue");if(e)try{this.events=JSON.parse(e)}catch(e){console.error("Failed to parse stored events:",e),this.events=[]}}addEvent(e){if(!e||"object"!=typeof e)throw new Error("Invalid event");e.eventId||(e.eventId=this._generateUUID()),e.type,this.events.push(e),this._persistEvents(),this.events.length>=this._config.batchSize&&this._flush()}getNextEvent(){return this.events.length>0?this.events[0]:null}removeEvent(){this.events.length>0&&(this.events.shift(),this._persistEvents())}clear(){if(this.events=[],this._config){this._processingQueue=[],this._stats={successfulEvents:0,failedEvents:0,totalProcessed:0,lastProcessTime:0},this._flushTimer&&(clearInterval(this._flushTimer),this._flushTimer=null);for(const e of this._retryTimeouts.values())clearTimeout(e);this._retryTimeouts.clear()}i.removeItem("mm_analytics_event_queue")}isEmpty(){return 0===this.events.length}getSize(){return this.events.length}getStatus(){if(!this._config)return{queueLength:this.events.length,processingLength:0,retryCount:0,successfulEvents:0,failedEvents:0,totalProcessed:0,processingTime:0,isProcessing:!1};for(const[e,t]of this._retryTimeouts.entries())(t._destroyed||t._called)&&this._retryTimeouts.delete(e);return{queueLength:this.events.length,processingLength:this._processingQueue.length,retryCount:this._retryTimeouts.size,successfulEvents:this._stats.successfulEvents,failedEvents:this._stats.failedEvents,totalProcessed:this._stats.totalProcessed,processingTime:this._stats.lastProcessTime,isProcessing:this._isProcessing}}_startFlushTimer(){this._flushTimer&&clearInterval(this._flushTimer);const e=this._config.flushInterval;this._flushTimer=setInterval((()=>{this.events.length>0&&(this.events.length,this._flush())}),e)}_persistEvents(){i.setItem("mm_analytics_event_queue",JSON.stringify(this.events))}async _flush(){if(this._isProcessing)return;if(0===this.events.length)return;this.events.length;const e=this._config.batchSize,t=this.events.splice(0,e);t.length;try{await this._sendBatch(t),t.length}catch(e){console.error("Error during flush:",e),t&&t.length>0&&this.events.unshift(...t)}}async _sendBatch(e){if(e&&0!==e.length&&!this._isProcessing){this._isProcessing=!0,e.length;try{for(const t of e)try{if(!t){console.error("Invalid event: null or undefined");continue}let e;if(t.qubitData)e={timestamp:t.timestamp,qubitData:t.qubitData};else{t.type;const r=t.data?.currentPayload||{};e={timestamp:t.timestamp||Date.now(),qubitData:[{streamID:{custId:r.customerId||r.custId||t.data?.customerId||t.data?.custId||"",subscriberId:r.subscriberId||t.data?.subscriberId||"",subscriberType:r.subscriberType||t.data?.subscriberType||"",subscriberTag:r.subscriberTag||t.data?.subscriberTag||"",sessionId:r.sessionId||t.data?.sessionId||t.sessionId||this._config?.getSessionId?.()||"",pId:r.profileId||t.data?.profileId||"",dataSrc:"Application"},sdkInfo:{sdkVersion:r.sdkVersion||t.data?.sdkVersion||"JSSDK1.0.0"},appEventInfo:{eventName:this._getEventName(t),eventType:this._getEventType(t),currentScreen:r.currentScreen||t.data?.currentScreen||"",isGraceful:r.isGraceful||t.data?.isGraceful||!1,eventData:r.eventData||t.data?.eventData||{}},userInfo:{profileId:r.profileId||t.data?.profileId||"",userData:r.userData||t.data?.userData||{},referralId:r.referralId||t.data?.referralId||"",referralData:r.referralData||t.data?.referralData||{}},clientInfo:{appName:r.appName||t.data?.appName||"",appVersion:r.appVersion||t.data?.appVersion||"",scrnRes:r.screenRes||r.scrnRes||t.data?.screenRes||t.data?.scrnRes||this._getScreenResolution(),deviceId:r.deviceId||t.data?.deviceId||"",deviceType:r.deviceType||t.data?.deviceType||"",deviceBrand:r.deviceBrand||t.data?.deviceBrand||"",deviceModel:r.deviceModel||t.data?.deviceModel||"",deviceMarketingName:r.deviceMarketingName||t.data?.deviceMarketingName||"",osVersion:r.osVersion||t.data?.osVersion||"",platform:r.platform||t.data?.platform||"",ua:r.userAgent||t.data?.userAgent||t.data?.clientInfo?.ua||""},customTags:r.customTags||t.data?.customTags||{}}]},e.qubitData[0].clientInfo.ua?e.qubitData[0].clientInfo.ua:(JSON.stringify(r,null,2),JSON.stringify(t.data,null,2))}if(this._removeEmptyFields(e),!t.qubitData&&!e.qubitData?.[0]?.streamID?.custId){console.error("Missing required field: custId");continue}this._producerURL,JSON.stringify(e,null,2);const r=await fetch(this._producerURL,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(r.status,r.statusText,!r.ok){const e=await r.text();throw console.error("Server response:",e),new Error(`HTTP error! status: ${r.status}, message: ${e}`)}const i=await r.text();let a=null;if(i&&i.trim())try{a=JSON.parse(i)}catch(e){a={success:!0,message:"Response received but not JSON"}}else a={success:!0,message:"Empty response received"};this.removeEvent(),this._stats.successfulEvents++,this._stats.totalProcessed++}catch(e){if(console.error("Error sending event:",e),this._stats.failedEvents++,this._stats.totalProcessed++,t.retryCount=(t.retryCount||0)+1,t.retryCount<this._config.maxRetries){t.retryCount,this._scheduleRetry(t);continue}}e.length}catch(e){console.error("Error processing batch:",e)}finally{this._isProcessing=!1,this.events.length>0&&this._scheduleNextBatch()}}}_removeEmptyFields(e){for(const t in e)null===e[t]||void 0===e[t]||""===e[t]?delete e[t]:"object"==typeof e[t]&&(this._removeEmptyFields(e[t]),0===Object.keys(e[t]).length&&delete e[t])}_getEventName(e){if(e.eventName)return e.eventName;switch(e.type){case"app_state":return"foreground"===e.state?"APP_FOREGROUND":"APP_BACKGROUND";case"user_identification":return"USER_IDENTIFICATION";case"session_start":return"SESSION_START";case"HEART_BEAT":return"STATS";default:return e.type||""}}_getEventType(e){if(e.eventType)return e.eventType;switch(e.type){case"app_state":return"APP_STATE";case"user_identification":return"USER_IDENTIFICATION";case"session_start":return"SESSION_START";case"HEART_BEAT":return"HEART_BEAT";default:return e.type||""}}_getEventData(e){const t={type:e.type||e.eventType||"",timestamp:e.timestamp||Date.now(),payloadId:e.payloadId||this._generateUUID(),dataSrc:"Application",sessionId:e.sessionId||""};switch(e.type||e.eventType){case"app_state":return{...t,state:e.state,appId:e.appId};case"user_identification":return{...t,userId:e.userId,email:e.email,demographics:e.demographics};case"session_start":return{...t,sessionId:e.sessionId};case"HEART_BEAT":return{...t,eventName:"STATS"};default:return t}}_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}_getScreenResolution(){return"undefined"!=typeof window&&window.screen?`${window.screen.width}x${window.screen.height}`:""}_scheduleRetry(e){const t=this._config.getConfig().retryDelay*Math.pow(2,(e.retryCount||0)-1),r=setTimeout((()=>{this.events.push(e),this._retryTimeouts.delete(e.eventId),this.events.length>=this._config.getConfig().batchSize&&this._flush()}),t);this._retryTimeouts.set(e.eventId,r)}async destroy(){if(this._config){this._flushTimer&&(clearInterval(this._flushTimer),this._flushTimer=null),this.events.length>0&&await this._flush();for(const e of this._retryTimeouts.values())clearTimeout(e);this._retryTimeouts.clear(),i.removeItem("mm_analytics_event_queue")}}_shouldProcessBatch(){return!!this._config&&this.events.length>=this._getBatchSize()}_getBatchSize(){return this._config.getConfig().batchSize}_getRetryDelay(){return this._config.getConfig().retryDelay}_getEndpoint(){return this._producerURL}async _processBatch(){try{const e=this._getBatchSize(),t=this.events.splice(0,e),r=Date.now();await this._sendBatch(t),this._stats.lastProcessTime=Date.now()-r}catch(e){this._handleError(e,"_processBatch")}}async _retryFailedEvents(){try{this._config.getConfig().retryDelay}catch(e){this._handleError(e,"_retryFailedEvents")}}_scheduleNextBatch(){this._isProcessing||setTimeout((()=>{this.events.length>0&&(this.events.length,this._flush())}),this._config.getConfig().flushInterval)}_handleError(e,t){console.error(`Error in EventQueue (${t}):`,e)}}class s{constructor(e,t){if(!e)throw new Error("Event queue is required");this._eventQueue=e,this._config=t,this._producerURL="https://streamproducer-lcrr.mediamelon.com",this._statsInterval=-1,this._heartbeatIntervalId=null,this._isHeartbeatRunning=!1,this._currentPayload=null,this._eventPayloadKeys={streamID:{fields:["customerId","subscriberId","subscriberType","subscriberTag","sessionId","payloadId","dataSrc"],mappings:{customerId:"custId",payloadId:"pId"}},sdkInfo:{fields:["sdkVersion"]},appEventInfo:{fields:["eventName","eventType","eventData","currentScreen","isGraceful"]},userInfo:{fields:["profileId","userData","referralId","referralData"]},clientInfo:{fields:["appName","appVersion","deviceId","deviceType","deviceBrand","deviceModel","deviceMarketingName","osVersion","platform","screenRes","userAgent"],mappings:{screenRes:"scrnRes",userAgent:"ua"}},customTags:{fields:["customTags"]}}}setProducerURL(e){if(!e||"string"!=typeof e)throw new Error("Valid producer URL is required");this._producerURL=e,this._eventQueue.setProducerURL(e)}setStatsInterval(e){if("number"!=typeof e)throw new Error("Stats interval must be a number");this._statsInterval=e}startSendingHeartBeatPayload(){this._isHeartbeatRunning||(this._isHeartbeatRunning=!0,this._statsInterval>0&&(this._heartbeatIntervalId=setInterval((()=>{if(this._currentPayload){const e={...this._currentPayload,eventName:"STATS",eventType:"HEART_BEAT",timestamp:Date.now(),payloadId:this._generateUUID(),dataSrc:"Application"},t={timestamp:e.timestamp,qubitData:[]},r={};for(const t in this._eventPayloadKeys)if(this._eventPayloadKeys.hasOwnProperty(t))if(e.hasOwnProperty(t))r[t]=e[t];else{r[t]={};const i=this._eventPayloadKeys[t].fields||[];for(const a of i){const i=this._eventPayloadKeys[t].mappings?.[a]||a;e[a]&&(r[t][i]=e[a])}}t.qubitData=[r],this._eventQueue.addEvent({type:"heartbeat",data:t,timestamp:e.timestamp})}}),1e3*this._statsInterval)))}stopSendingHeartBeatPayload(){this._isHeartbeatRunning=!1,this._heartbeatIntervalId&&(clearInterval(this._heartbeatIntervalId),this._heartbeatIntervalId=null)}updateCurrentPayload(e){if(!e)return;const t=["customerId","appName","appVersion"].filter((t=>!e[t]));t.length>0&&t.join(", "),this._currentPayload={...this._currentPayload,...e,customerId:e.customerId||this._currentPayload?.customerId||"",appName:e.appName||this._currentPayload?.appName||"",appVersion:e.appVersion||this._currentPayload?.appVersion||"",sdkVersion:e.sdkVersion||this._currentPayload?.sdkVersion||"JSSDK1.0.0",sessionId:e.sessionId||this._currentPayload?.sessionId||"",screenRes:e.screenRes||this._currentPayload?.screenRes||this._getScreenResolution(),custId:e.customerId||e.custId||this._currentPayload?.custId||"",subscriberId:e.subscriberId||this._currentPayload?.subscriberId||"",subscriberType:e.subscriberType||this._currentPayload?.subscriberType||"",subscriberTag:e.subscriberTag||this._currentPayload?.subscriberTag||"",clientInfo:{appName:e.appName||this._currentPayload?.clientInfo?.appName||"",appVersion:e.appVersion||this._currentPayload?.clientInfo?.appVersion||"",scrnRes:e.screenRes||e.scrnRes||this._currentPayload?.clientInfo?.scrnRes||this._getScreenResolution(),ua:e.userAgent||this._currentPayload?.clientInfo?.ua||""},userInfo:{profileId:e.profileId||this._currentPayload?.userInfo?.profileId||"",userData:e.userData||this._currentPayload?.userInfo?.userData||{},referralId:e.referralId||this._currentPayload?.userInfo?.referralId||"",referralData:e.referralData||this._currentPayload?.userInfo?.referralData||{}},customTags:e.customTags||this._currentPayload?.customTags||{}}}publishEvent(e,t){if(!this._currentPayload)return;this._currentPayload.sessionId;const r={...this._currentPayload,...t,timestamp:Date.now(),payloadId:this._generateUUID()};if(r.sessionId,!r.sessionId){const e=this._config?.getSessionId?.();e&&(r.sessionId=e)}const i={timestamp:r.timestamp,qubitData:[{streamID:{custId:r.customerId||r.custId||"",subscriberId:r.subscriberId||"",subscriberType:r.subscriberType||"",subscriberTag:r.subscriberTag||"",sessionId:r.sessionId||"",pId:r.profileId||"",dataSrc:"Application"},sdkInfo:{sdkVersion:r.sdkVersion||"JSSDK1.0.0"},appEventInfo:{eventName:this._getEventName(e,t),eventType:this._getEventType(e,t),currentScreen:r.currentScreen||"",isGraceful:r.isGraceful||!1},userInfo:{profileId:r.profileId||"",userData:r.userData||{},referralId:r.referralId||"",referralData:r.referralData||{}},clientInfo:{appName:r.appName||"",appVersion:r.appVersion||"",scrnRes:r.screenRes||r.scrnRes||this._getScreenResolution(),ua:r.userAgent||r.ua||""},customTags:r.customTags||{}}]};this._removeEmptyFields(i),this._eventQueue.addEvent({type:e,qubitData:i.qubitData,timestamp:r.timestamp})}_getEventName(e,t){return t.eventName?t.eventName:{app_state:e=>"foreground"===e.state?"APP_FOREGROUND":"APP_BACKGROUND",user_identification:()=>"USER_IDENTIFICATION",session_start:()=>"SESSION_START",screen_view:e=>e.currentScreen||"SCREEN_VIEW",HEART_BEAT:()=>"STATS"}[e]?.(t)||e.toUpperCase()}_getEventType(e,t){return t.eventType?t.eventType:{app_state:"APP_STATE",user_identification:"USER_IDENTIFICATION",session_start:"SESSION_START",screen_view:"SCREEN_VIEW",HEART_BEAT:"HEART_BEAT"}[e]||e.toUpperCase()}_getEventData(e){return{type:e.type||e.eventType,timestamp:e.timestamp,payloadId:e.payloadId||this._generateUUID(),dataSrc:"Application",sessionId:e.sessionId,appName:e.appName,appVersion:e.appVersion,...{APP_STATE:{state:e.state,appId:e.appId,isGraceful:e.isGraceful||!1},SCREEN_VIEW:{screenName:e.currentScreen,previousScreen:e.previousScreen,screenType:e.screenType},USER_IDENTIFICATION:{userId:e.userId,email:e.email,demographics:e.demographics,userData:e.userData},SESSION_START:{sessionId:e.sessionId,startTime:e.timestamp},HEART_BEAT:{eventName:"STATS",timestamp:e.timestamp}}[e.type?.toUpperCase()||e.eventType]||{}}}_removeEmptyFields(e){for(const t in e)null===e[t]||void 0===e[t]||""===e[t]?delete e[t]:"object"!=typeof e[t]||Array.isArray(e[t])||(this._removeEmptyFields(e[t]),0===Object.keys(e[t]).length&&delete e[t])}_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}_getScreenResolution(){return"undefined"!=typeof window&&window.screen?`${window.screen.width}x${window.screen.height}`:""}}class n{constructor(e){this._config=e,this._errorCallbacks=new Map,this._recoveryStrategies=new Map,this._errorHistory=[],this._maxHistorySize=100}handleError(e,t,r={}){const i=this._categorizeError(e,t,r);return this._addToHistory(i),this._recoveryStrategies.has(i.category)&&this._recoveryStrategies.get(i.category)(i),this._notifyErrorCallbacks(i),this._shouldReportError(e)&&this._reportError(i),!0}onError(e,t){this._errorCallbacks.has(e)||this._errorCallbacks.set(e,new Set),this._errorCallbacks.get(e).add(t)}registerRecoveryStrategy(e,t){this._recoveryStrategies.set(e,t)}getErrorHistory(){return[...this._errorHistory]}clearErrorHistory(){this._errorHistory=[]}_categorizeError(e,t,r){let i="unknown",a="error";return"NetworkError"===e.name||e.message.includes("network")?i="network":"ValidationError"===e.name||e.message.includes("validation")?i="validation":"StateError"===e.name||e.message.includes("state")?i="state":"ConfigurationError"===e.name||e.message.includes("config")?i="configuration":("StorageError"===e.name||e.message.includes("storage"))&&(i="storage"),e.critical||e.message.includes("critical")?a="critical":e.warning||e.message.includes("warning")?a="warning":(e.info||e.message.includes("info"))&&(a="info"),{timestamp:Date.now(),category:i,severity:a,context:t,message:e.message,stack:e.stack,...r}}_addToHistory(e){this._errorHistory.unshift(e),this._errorHistory.length>this._maxHistorySize&&this._errorHistory.pop()}_notifyErrorCallbacks(e){this._errorCallbacks.has(e.category)&&this._errorCallbacks.get(e.category).forEach((t=>{try{t(e)}catch(e){console.error("Error in error callback:",e)}})),this._errorCallbacks.has("*")&&this._errorCallbacks.get("*").forEach((t=>{try{t(e)}catch(e){console.error("Error in global error callback:",e)}}))}async _reportError(e){try{const t=this._getErrorEndpoint(),r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:e,metadata:this._config.getEventMetadata()})});if(!r.ok)throw new Error(`Failed to report error: ${r.status}`)}catch(e){console.error("Error reporting to backend:",e)}}_shouldReportError(e){return this._config.getConfig().errorReporting}_getErrorEndpoint(){return this._config.getConfig().errorEndpoint}_createErrorEvent(e,t,r){return{error:e.message,context:t,timestamp:Date.now(),stack:e.stack,metadata:this._config.getEventMetadata()}}}const o={DEBUG:"debug",INFO:"info",WARN:"warn",ERROR:"error"},d={[o.DEBUG]:0,[o.INFO]:1,[o.WARN]:2,[o.ERROR]:3};class c{constructor(e={}){this._config=e,this._logHistory=[],this._logCallbacks=new Map,this._maxHistorySize=e.maxLogHistorySize||1e3,this._enabled=!0,this._currentLevel=o.INFO,this._userId=null}updateConfig(e){this._config=e,this._maxHistorySize=e.maxLogHistorySize||1e3}setUserId(e){this._userId=e}debug(e,t={}){this._log(o.DEBUG,e,t)}info(e,t={}){this._log(o.INFO,e,t)}warn(e,t={}){this._log(o.WARN,e,t)}error(e,t={}){this._log(o.ERROR,e,t)}setLogLevel(e){o[e.toUpperCase()]&&(this._currentLevel=e.toLowerCase())}setEnabled(e){this._enabled=e}onLog(e,t){this._logCallbacks.has(e)||this._logCallbacks.set(e,new Set),this._logCallbacks.get(e).add(t)}_log(e,t,r){if(!this._enabled||d[e]<d[this._currentLevel])return;const i={timestamp:Date.now(),level:e,message:t,data:r,userId:this._userId,context:this._getContext()};this._notifyCallbacks(i),this._consoleOutput(i)}_getContext(){return{sdkVersion:this._config.getAppInfo().sdkVersion,environment:this._config.getConfig().environment,appVersion:this._config.getAppInfo().appVersion,timestamp:Date.now()}}_notifyCallbacks(e){this._logCallbacks.has(e.level)&&this._logCallbacks.get(e.level).forEach((t=>{try{t(e)}catch(e){console.error("Error in log callback:",e)}})),this._logCallbacks.has("*")&&this._logCallbacks.get("*").forEach((t=>{try{t(e)}catch(e){console.error("Error in global log callback:",e)}}))}_consoleOutput(e){const t=new Date(e.timestamp).toISOString(),r=e.userId?`[User: ${e.userId}]`:"",i=`[${t}] [${e.level.toUpperCase()}] ${r} ${e.message}`;switch(e.level){case o.DEBUG:console.debug(i,e.data);break;case o.INFO:case o.WARN:e.data;break;case o.ERROR:console.error(i,e.data)}}_createLogEntry(e,t,r){return{level:e,message:t,data:r,timestamp:Date.now(),sdkVersion:this._config.getAppInfo().sdkVersion,environment:this._config.getConfig().environment,appVersion:this._config.getAppInfo().appVersion}}}const l="type",h="format",u="state",p={video:{states:["idle","loading","playing","paused","ended","error"],transitions:{null:["idle","loading","playing"],idle:["loading","playing"],loading:["playing","error"],playing:["paused","ended","error"],paused:["playing","ended"],ended:["idle","loading"],error:["idle"]}},app:{states:["foreground","background"],transitions:{null:["foreground","background"],foreground:["background"],background:["foreground"]}},screen:{states:["active","inactive"],transitions:{null:["active"],active:["inactive"],inactive:["active"]}}};function _(e){Object.entries(e).forEach((([e,t])=>{if(null==t||""===t)throw new Error(`${e} is required`)}))}class g{constructor(e={}){if(!e)throw new Error("Config is required for Validator");this._config=e}updateConfig(e){this._config=e}validateInitParams(e){if(!e||"object"!=typeof e)throw this._createError(l,"Initialization parameters must be an object");const{customerId:t,appId:r,appName:i,appVersion:a}=e;this._validateRequired({customerId:t,appId:r,appName:i,appVersion:a}),this._validateType({customerId:{value:t,type:"string"},appId:{value:r,type:"string"},appName:{value:i,type:"string"},appVersion:{value:a,type:"string"}}),this._validateFormat({appVersion:{value:a,pattern:/^\d+\.\d+\.\d+$/}})}validateEventData(e,t){if(!e||"string"!=typeof e)throw this._createError(l,"eventName must be a string");if(!t||"object"!=typeof t)throw this._createError(l,"eventData must be an object");switch(e){case"video_start":case"video_pause":case"video_resume":case"video_skip":case"video_stop":case"video_end":case"video_buffering":this._validateVideoEvent(e,t);break;case"video_quality_change":this._validateVideoQualityChange(t);break;case"screen_view":this._validateScreenView(t);break;case"app_state":this._validateAppState(t);break;case"app_error":case"error":this._validateAppError(t);break;case"app_performance":case"performance_metrics":this._validatePerformanceMetrics(t);break;case"subscription_start":case"subscription_renewal":case"subscription_cancellation":case"subscription":const{type:r,...i}=t;this._validateSubscriptionEvent(e,i);break;case"experiment_exposure":case"experiment_activation":this._validateExperimentEvent(e,t);break;case"user_info":this._validateUserInfo(t);break;case"user_click":this._validateUserClick(t);break;case"user_scroll":this._validateUserScroll(t);break;case"user_session_end":this._validateUserSessionEnd(t);break;case"custom":this._validateCustomEvent(t);break;default:t.type&&this._validateType({type:{value:t.type,type:"string"}})}}validateStateTransition(e,t,r){if(!r||"string"!=typeof r)throw this._createError(l,"stateType must be a string");if(!t||"string"!=typeof t)throw this._createError(l,"newState must be a string");const i=p[r];if(!i)throw this._createError(u,`Invalid state type: ${r}`);if(!i.states.includes(t))throw this._createError(u,`Invalid state: ${t}. Must be one of: ${i.states.join(", ")}`);const a=e||"null",s=i.transitions[a];if(!s||!s.includes(t))throw this._createError(u,`Invalid transition from ${e||"null"} to ${t} for ${r}`)}validateConfig(e){if(!e||"object"!=typeof e)throw this._createError(l,"Configuration must be an object");this._validateRequired({endpoint:e.endpoint,batchSize:e.batchSize,flushInterval:e.flushInterval}),this._validateType({endpoint:{value:e.endpoint,type:"string"},batchSize:{value:e.batchSize,type:"number"},flushInterval:{value:e.flushInterval,type:"number"},maxRetries:{value:e.maxRetries,type:"number"},retryDelay:{value:e.retryDelay,type:"number"}}),this._validateRange({batchSize:{value:e.batchSize,min:1,max:1e3},flushInterval:{value:e.flushInterval,min:1e3,max:6e4},maxRetries:{value:e.maxRetries,min:0,max:10},retryDelay:{value:e.retryDelay,min:1e3,max:3e4}})}_validateRequired(e){Object.entries(e).forEach((([e,t])=>{if(null==t||""===t)throw this._createError("required",`${e} is required`)}))}_validateType(e){Object.entries(e).forEach((([e,{value:t,type:r}])=>{if(null!=t){const i=typeof t;if(i!==r)throw this._createError(l,`${e} must be of type ${r}, got ${i}`)}}))}_validateFormat(e){Object.entries(e).forEach((([e,{value:t,pattern:r}])=>{if(null!=t&&!r.test(t))throw this._createError(h,`${e} has invalid format`)}))}_validateRange(e){Object.entries(e).forEach((([e,{value:t,min:r,max:i}])=>{if(null!=t&&(t<r||t>i))throw this._createError("range",`${e} must be between ${r} and ${i}`)}))}_validateEnum(e){Object.entries(e).forEach((([e,{value:t,values:r}])=>{if(null!=t&&!r.includes(t))throw this._createError("enum",`${e} must be one of: ${r.join(", ")}`)}))}_validateVideoState(e){this._validateRequired({state:e.state}),this._validateEnum({state:{value:e.state,values:p.video.states}}),void 0!==e.duration&&(this._validateType({duration:{value:e.duration,type:"number"}}),this._validateRange({duration:{value:e.duration,min:0,max:Number.MAX_SAFE_INTEGER}})),void 0!==e.currentTime&&(this._validateType({currentTime:{value:e.currentTime,type:"number"}}),this._validateRange({currentTime:{value:e.currentTime,min:0,max:e.duration||Number.MAX_SAFE_INTEGER}}))}_validateScreenView(e){this._validateRequired({screenName:e.screenName}),this._validateType({screenName:{value:e.screenName,type:"string"},screenId:{value:e.screenId,type:"string"},previousScreen:{value:e.previousScreen,type:"string"}})}_validateAppState(e){this._validateRequired({state:e.state}),this._validateEnum({state:{value:e.state,values:p.app.states}}),void 0!==e.timestamp&&this._validateType({timestamp:{value:e.timestamp,type:"number"}})}_validateAppError(e){this._validateRequired({errorCode:e.errorCode,errorMessage:e.errorMessage}),this._validateType({errorCode:{value:e.errorCode,type:"string"},errorMessage:{value:e.errorMessage,type:"string"},stackTrace:{value:e.stackTrace,type:"string"},timestamp:{value:e.timestamp,type:"number"}}),e.metadata&&this._validateType({metadata:{value:e.metadata,type:"object"}})}_validateUserInfo(e){this._validateRequired({userId:e.userId}),this._validateType({userId:{value:e.userId,type:"string"},userType:{value:e.userType,type:"string"},deviceId:{value:e.deviceId,type:"string"}})}_validateCustomEvent(e){this._validateRequired({eventName:e.eventName}),this._validateType({eventName:{value:e.eventName,type:"string"}}),void 0!==e.eventData&&this._validateType({eventData:{value:e.eventData,type:"object"}})}_validateVideoEvent(e,t){if(this._validateRequired({assetId:t.assetId,assetName:t.assetName,duration:t.duration,position:t.position,quality:t.quality,reason:t.reason}),this._validateType({assetId:{value:t.assetId,type:"string"},assetName:{value:t.assetName,type:"string"},duration:{value:t.duration,type:"number"},position:{value:t.position,type:"number"},quality:{value:t.quality,type:"string"},reason:{value:t.reason,type:"string"}}),this._validateRange({duration:{value:t.duration,min:0,max:Number.MAX_SAFE_INTEGER},position:{value:t.position,min:0,max:t.duration||Number.MAX_SAFE_INTEGER}}),t.metadata){this._validateType({metadata:{value:t.metadata,type:"object"}});const e=["playbackSpeed","bufferingTime","bitrate","resolution","playerVersion","playerType"];Object.keys(t.metadata).forEach((t=>{if(!e.includes(t))throw this._createError(h,`Invalid metadata field: ${t}. Must be one of: ${e.join(", ")}`)})),void 0!==t.metadata.playbackSpeed&&this._validateType({"metadata.playbackSpeed":{value:t.metadata.playbackSpeed,type:"number"}}),void 0!==t.metadata.bufferingTime&&this._validateType({"metadata.bufferingTime":{value:t.metadata.bufferingTime,type:"number"}}),void 0!==t.metadata.bitrate&&this._validateType({"metadata.bitrate":{value:t.metadata.bitrate,type:"number"}}),void 0!==t.metadata.resolution&&this._validateType({"metadata.resolution":{value:t.metadata.resolution,type:"string"}}),void 0!==t.metadata.playerVersion&&this._validateType({"metadata.playerVersion":{value:t.metadata.playerVersion,type:"string"}}),void 0!==t.metadata.playerType&&this._validateType({"metadata.playerType":{value:t.metadata.playerType,type:"string"}})}}_validateVideoQualityChange(e){if(this._validateRequired({assetId:e.assetId,assetName:e.assetName,quality:e.quality,reason:e.reason}),this._validateType({assetId:{value:e.assetId,type:"string"},assetName:{value:e.assetName,type:"string"},quality:{value:e.quality,type:"string"},reason:{value:e.reason,type:"string"}}),e.metadata){this._validateType({metadata:{value:e.metadata,type:"object"}});const t=["playbackSpeed","bufferingTime","bitrate","resolution","playerVersion","playerType","previousQuality"];Object.keys(e.metadata).forEach((e=>{if(!t.includes(e))throw this._createError(h,`Invalid metadata field: ${e}. Must be one of: ${t.join(", ")}`)})),void 0!==e.metadata.previousQuality&&this._validateType({"metadata.previousQuality":{value:e.metadata.previousQuality,type:"string"}})}}_validatePerformanceMetrics(e){this._validateRequired({timestamp:e.timestamp,metrics:e.metrics}),this._validateType({timestamp:{value:e.timestamp,type:"number"},metrics:{value:e.metrics,type:"object"}});const t=["memoryUsage","cpuUsage","networkLatency","frameRate","loadTime","renderTime","jsHeapSize","jsHeapSizeLimit"];Object.keys(e.metrics).forEach((r=>{if(!t.includes(r))throw this._createError(h,`Invalid metric field: ${r}. Must be one of: ${t.join(", ")}`);this._validateType({[`metrics.${r}`]:{value:e.metrics[r],type:"number"}})})),e.metadata&&this._validateType({metadata:{value:e.metadata,type:"object"}})}_validateSubscriptionEvent(e,t){if(this._validateRequired({subscriptionId:t.subscriptionId,planId:t.planId,planName:t.planName,amount:t.amount,currency:t.currency,duration:t.duration,measure:t.measure,status:t.status}),this._validateType({subscriptionId:{value:t.subscriptionId,type:"string"},planId:{value:t.planId,type:"string"},planName:{value:t.planName,type:"string"},amount:{value:t.amount,type:"number"},currency:{value:t.currency,type:"string"},duration:{value:t.duration,type:"number"},measure:{value:t.measure,type:"string"},status:{value:t.status,type:"string"}}),t.metadata){this._validateType({metadata:{value:t.metadata,type:"object"}});const e=["paymentMethod","autoRenew","trialPeriod","startDate","endDate","cancellationReason"];Object.keys(t.metadata).forEach((t=>{if(!e.includes(t))throw this._createError(h,`Invalid metadata field: ${t}. Must be one of: ${e.join(", ")}`)}))}}_validateExperimentEvent(e,t){if(this._validateRequired({experimentId:t.experimentId,experimentName:t.experimentName,variantId:t.variantId,variantName:t.variantName,timestamp:t.timestamp}),this._validateType({experimentId:{value:t.experimentId,type:"string"},experimentName:{value:t.experimentName,type:"string"},variantId:{value:t.variantId,type:"string"},variantName:{value:t.variantName,type:"string"},timestamp:{value:t.timestamp,type:"number"}}),t.metadata){this._validateType({metadata:{value:t.metadata,type:"object"}});const e=["exposureType","source","context","activationType"];Object.keys(t.metadata).forEach((t=>{if(!e.includes(t))throw this._createError(h,`Invalid metadata field: ${t}. Must be one of: ${e.join(", ")}`)})),t.metadata.context&&this._validateType({"metadata.context":{value:t.metadata.context,type:"object"}})}}_validateUserClick(e){this._validateRequired({elementId:e.elementId,elementType:e.elementType}),this._validateType({elementId:{value:e.elementId,type:"string"},elementType:{value:e.elementType,type:"string"},pageUrl:{value:e.pageUrl,type:"string"},position:{value:e.position,type:"object"},timestamp:{value:e.timestamp,type:"number"}}),e.position&&this._validateType({"position.x":{value:e.position.x,type:"number"},"position.y":{value:e.position.y,type:"number"}})}_validateUserScroll(e){this._validateRequired({scrollDepth:e.scrollDepth}),this._validateType({scrollDepth:{value:e.scrollDepth,type:"number"},scrollPercentage:{value:e.scrollPercentage,type:"number"},pageUrl:{value:e.pageUrl,type:"string"},timestamp:{value:e.timestamp,type:"number"}}),void 0!==e.scrollPercentage&&this._validateRange({scrollPercentage:{value:e.scrollPercentage,min:0,max:100}})}_validateUserSessionEnd(e){this._validateRequired({userId:e.userId,sessionId:e.sessionId,timestamp:e.timestamp}),this._validateType({userId:{value:e.userId,type:"string"},sessionId:{value:e.sessionId,type:"string"},timestamp:{value:e.timestamp,type:"number"}}),e.metadata&&this._validateType({metadata:{value:e.metadata,type:"object"}})}_createError(e,t){const r=new Error(t);return r.type=e,r}}class v{constructor(e){if(!e)throw new Error("Dependencies are required for tracker initialization");const{config:t,eventPublisher:r,logger:i,validator:a,errorHandler:s,stateManager:n}=e;if(!t)throw new Error("Config is required");if(!r)throw new Error("Event publisher is required");if(!i)throw new Error("Logger is required");if(!a)throw new Error("Validator is required");if(!s)throw new Error("Error handler is required");this._config=t,this._eventPublisher=r,this._logger=i,this._validator=a,this._errorHandler=s,this._stateManager=n}updateConfig(e){this._config=e}_createEventData(e){return{...e,timestamp:this._getTimestamp(),sessionId:this._config.getSessionId(),deviceInfo:this._config.getDeviceInfo(),appInfo:this._config.getAppInfo()}}_publishEvent(e,t){try{this._eventPublisher.publishEvent(e,t),this._logger.debug(`Event published: ${e}`,t)}catch(t){this._handleError(t,"_publishEvent",`${e}_error`)}}_handleError(e,t,r="tracker_error"){this._logger.error(`Error in ${t}:`,e);const i={error:e.message,context:t,timestamp:Date.now(),stack:e.stack};this._publishEvent(r,i),this._errorHandler.handleError(e,t,{eventType:r,tracker:this.constructor.name})}_getTimestamp(){return Date.now()}}class m extends v{constructor(e){super({...e,stateManager:e.stateManager||new r})}reportVideoStart(e){try{this._validator.validateEventData("video_start",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_start",t),this._logger.debug("Video start reported",t)}catch(e){this._handleError(e,"reportVideoStart","video_error")}}reportVideoPause(e){try{this._validator.validateEventData("video_pause",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_pause",t),this._logger.debug("Video pause reported",t)}catch(e){this._handleError(e,"reportVideoPause","video_error")}}reportVideoResume(e){try{this._validator.validateEventData("video_resume",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_resume",t),this._logger.debug("Video resume reported",t)}catch(e){this._handleError(e,"reportVideoResume","video_error")}}reportVideoSkip(e){try{this._validator.validateEventData("video_skip",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_skip",t),this._logger.debug("Video skip reported",t)}catch(e){this._handleError(e,"reportVideoSkip","video_error")}}reportVideoStop(e){try{this._validator.validateEventData("video_stop",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_stop",t),this._logger.debug("Video stop reported",t)}catch(e){this._handleError(e,"reportVideoStop","video_error")}}reportVideoEnd(e){try{this._validator.validateEventData("video_end",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_end",t),this._logger.debug("Video end reported",t)}catch(e){this._handleError(e,"reportVideoEnd","video_error")}}reportVideoQualityChange(e){try{this._validator.validateEventData("video_quality_change",e);const t=this._createEventData(e);this._publishEvent("video_quality_change",t),this._logger.debug("Video quality change reported",t)}catch(e){this._handleError(e,"reportVideoQualityChange","video_error")}}reportVideoBuffering(e){try{this._validator.validateEventData("video_buffering",e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent("video_buffering",t),this._logger.debug("Video buffering reported",t)}catch(e){this._handleError(e,"reportVideoBuffering","video_error")}}getVideoState(){return this._stateManager.getVideoState()}}class f extends v{constructor(e){super(e)}reportScreenView(e){try{this._validator.validateEventData("screen_view",e);const t=this._createEventData(e);this._publishEvent("screen_view",t),this._logger.debug("Screen view reported",t)}catch(e){this._handleError(e,"reportScreenView","screen_error")}}reportScreenExit(e){try{this._validator.validateEventData("screen_exit",e);const t=this._createEventData(e);this._publishEvent("screen_exit",t),this._logger.debug("Screen exit reported",t)}catch(e){this._handleError(e,"reportScreenExit","screen_error")}}getScreenState(){return this._stateManager.getScreenState()}}class y extends v{constructor(e){super(e)}reportAppState(e){try{this._validator.validateEventData("app_state",e);const t=this._createEventData(e);this._publishEvent("app_state",t),this._logger.debug("Application state reported",t)}catch(e){this._handleError(e,"reportAppState","app_error")}}reportAppError(e){try{this._validator.validateEventData("app_error",e);const t=this._createEventData(e);this._publishEvent("app_error",t),this._logger.debug("Application error reported",t)}catch(e){this._handleError(e,"reportAppError","app_error")}}reportPerformanceMetrics(e){try{this._validator.validateEventData("app_performance",e);const t=this._createEventData(e);this._publishEvent("app_performance",t),this._logger.debug("Application performance metrics reported",t)}catch(e){this._handleError(e,"reportPerformanceMetrics","app_error")}}getAppState(){return this._stateManager.getAppState()}_validateAppData(e,t){if(!e||"object"!=typeof e)throw new Error("Invalid application data");this._validator.validateEventData(t,e)}}class E extends v{constructor(e){super(e)}reportUserIdentification(e){try{this._validator.validateEventData("user_identification",e);const t=this._createEventData(e);this._publishEvent("user_identification",t)}catch(e){this._handleError(e,"reportUserIdentification","user_error")}}reportUserProfileUpdate(e){try{this._validator.validateEventData("user_profile_update",e);const t=this._createEventData(e);this._publishEvent("user_profile_update",t)}catch(e){this._handleError(e,"reportUserProfileUpdate","user_error")}}reportUserPreferenceUpdate(e){try{this._validator.validateEventData("user_preference_update",e);const t=this._createEventData(e);this._publishEvent("user_preference_update",t)}catch(e){this._handleError(e,"reportUserPreferenceUpdate","user_error")}}reportUserSessionEnd(e){try{this._validator.validateEventData("user_session_end",e);const t=this._createEventData(e);this._publishEvent("user_session_end",t)}catch(e){this._handleError(e,"reportUserSessionEnd","user_error")}}}class b{constructor(e,t,i){this._config=e,this._logger=t,this._eventPublisher=i,this._enabled=!1,this._isTracking=!1,this._lastActivity=Date.now(),this._activityTimeout=null,this._sessionTimeout=null,this._eventQueue=new a(e),this._stateManager=new r,this._validator=new g(e),this._sessionStartTime=null,this._lastActivityTime=null,this._currentPath=null,this._previousPath=null,this._navigationStartTime=null,this._clickCount=0,this._lastClickTime=null,this._scrollDepth=0,this._maxScrollDepth=0,this._scrollStartTime=null,this._boundHandleSessionStart=this._handleSessionStart.bind(this),this._boundHandleSessionEnd=this._handleSessionEnd.bind(this),this._boundHandleNavigation=this._handleNavigation.bind(this),this._boundHandleClick=this._handleClick.bind(this),this._boundHandleScroll=this._handleScroll.bind(this),this._initializeEventListeners()}_initializeEventListeners(){if("undefined"!=typeof window){if(window.addEventListener("load",this._boundHandleSessionStart),window.addEventListener("beforeunload",this._boundHandleSessionEnd),window.addEventListener("popstate",this._boundHandleNavigation),"undefined"!=typeof history){const e=history.pushState;history.pushState=(...t)=>{e.apply(history,t),this._boundHandleNavigation()}}document.addEventListener("click",this._boundHandleClick),window.addEventListener("scroll",this._boundHandleScroll)}}_handleSessionStart(){if(!this._isTracking){this._isTracking=!0,this._lastActivity=Date.now(),this._resetTimers();try{this._sessionStartTime=Date.now(),this._lastActivityTime=this._sessionStartTime;const e={timestamp:Date.now(),sessionId:this._config.getSessionId(),deviceInfo:this._config.getDeviceInfo(),appInfo:this._config.getAppInfo()};this._eventPublisher.publishEvent("session_start",e),this._logger.debug("Session started",{sessionId:this._config.getSessionId()})}catch(e){this._handleError(e,"session_start")}}}_handleSessionEnd(){if(!this._isTracking)return;const e={timestamp:Date.now(),sessionId:this._config.getSessionId(),deviceInfo:this._config.getDeviceInfo(),appInfo:this._config.getAppInfo()};this._eventPublisher.publishEvent("session_end",e),this._logger.debug("Session ended",{sessionId:this._config.getSessionId()}),this._isTracking=!1,this._clearTimers();try{const e=Date.now()-this._sessionStartTime,t=Date.now()-this._lastActivityTime;this._eventQueue.addEvent({type:"session_end",data:{sessionId:this._config.getSessionId(),endTime:Date.now(),duration:e,inactivityDuration:t,clickCount:this._clickCount,maxScrollDepth:this._maxScrollDepth}})}catch(e){this._handleError(e,"session_end")}}_handleNavigation(){try{const e=window.location.pathname;if(e===this._currentPath)return;this._previousPath=this._currentPath,this._currentPath=e,this._navigationStartTime=Date.now();const t={currentPath:this._currentPath,previousPath:this._previousPath,timestamp:this._navigationStartTime,referrer:document.referrer};this._eventPublisher.publishEvent("navigation",t),this._logger.debug("Navigation tracked",{path:this._currentPath})}catch(e){this._handleError(e,"navigation")}}_handleClick(e){try{this._clickCount++,this._lastClickTime=Date.now(),this._lastActivityTime=this._lastClickTime;const t=e.target,r={timestamp:this._lastClickTime,target:{tagName:t.tagName,id:t.id,className:t.className,text:t.textContent?.trim().substring(0,100),href:t.href,type:t.type},position:{x:e.clientX,y:e.clientY}};this._eventPublisher.publishEvent("click",r),this._logger.debug("Click tracked",r)}catch(e){this._handleError(e,"click")}}_handleScroll(){if(this._config&&this._logger&&this._eventPublisher)try{const e=window.pageYOffset||document.documentElement.scrollTop,t=document.documentElement.scrollHeight,r=document.documentElement.clientHeight,i=(e+r)/t*100;if(i>this._maxScrollDepth){this._maxScrollDepth=i,this._scrollStartTime=this._scrollStartTime||Date.now(),this._lastActivityTime=Date.now();const a={depth:i,timestamp:Date.now(),scrollTop:e,scrollHeight:t,clientHeight:r};this._eventPublisher.publishEvent("scroll_depth",a),this._logger.debug("Scroll depth tracked",{depth:i})}}catch(e){this._handleError(e,"scroll")}}_handleError(e,t){try{const r=e instanceof Error?e.message:String(e);this._logger&&this._logger.error(`Error in ${t}:`,e),this._eventQueue&&this._eventQueue.addEvent({type:"auto_collection_error",data:{error:r,context:t,timestamp:Date.now()}})}catch(r){console.error("Error in error handler:",r),console.error("Original error:",e),console.error("Context:",t)}}getSessionInfo(){return{sessionId:this._config.getSessionId(),startTime:this._sessionStartTime,lastActivityTime:this._lastActivityTime,clickCount:this._clickCount,maxScrollDepth:this._maxScrollDepth}}getNavigationInfo(){return{currentPath:this._currentPath,previousPath:this._previousPath,navigationStartTime:this._navigationStartTime}}setEnabled(e){e?this._initializeEventListeners():this._removeEventListeners()}_removeEventListeners(){"undefined"!=typeof window&&(window.removeEventListener("load",this._boundHandleSessionStart),window.removeEventListener("beforeunload",this._boundHandleSessionEnd),window.removeEventListener("popstate",this._boundHandleNavigation),document.removeEventListener("click",this._boundHandleClick),window.removeEventListener("scroll",this._boundHandleScroll))}_resetTimers(){this._activityTimeout=setTimeout((()=>{this._endSession()}),this._config.getActivityTimeout()),this._sessionTimeout=setTimeout((()=>{this._endSession()}),this._config.getSessionTimeout())}_clearTimers(){clearTimeout(this._activityTimeout),clearTimeout(this._sessionTimeout)}_createEventData(e,t={}){return{type:e,timestamp:Date.now(),sessionId:this._config.getSessionId(),deviceInfo:this._config.getDeviceInfo(),appInfo:this._config.getAppInfo(),...t}}}class I extends v{constructor(e){super(e)}reportSubscriptionStart(e){try{this._validator.validateEventData("subscription_start",e);const t=this._createEventData(e);this._publishEvent("subscription_start",t)}catch(e){this._handleError(e,"reportSubscriptionStart","subscription_error")}}reportSubscriptionRenewal(e){try{const{metadata:t,...r}=e,i={paymentMethod:t?.paymentMethod,autoRenew:t?.autoRenew,trialPeriod:t?.trialPeriod,startDate:t?.renewalDate||t?.startDate,endDate:t?.nextRenewalDate||t?.endDate},a=this._createEventData({...r,metadata:i});this._validator.validateEventData("subscription_renewal",a),this._publishEvent("subscription_renewal",a)}catch(e){this._handleError(e,"reportSubscriptionRenewal","subscription_error")}}reportSubscriptionCancellation(e){try{const{metadata:t,...r}=e,i={paymentMethod:t?.paymentMethod,autoRenew:t?.autoRenew,trialPeriod:t?.trialPeriod,startDate:t?.startDate,endDate:t?.cancellationDate||t?.endDate,cancellationReason:t?.reason||t?.cancellationReason},a=this._createEventData({...r,metadata:i});this._validator.validateEventData("subscription_cancellation",a),this._publishEvent("subscription_cancellation",a)}catch(e){this._handleError(e,"reportSubscriptionCancellation","subscription_error")}}reportSubscriptionExpiration(e){try{this._validator.validateEventData("subscription_expiration",e);const t=this._createEventData(e);this._publishEvent("subscription_expiration",t)}catch(e){this._handleError(e,"reportSubscriptionExpiration","subscription_error")}}reportSubscriptionUpgrade(e){try{this._validator.validateEventData("subscription_upgrade",e);const t=this._createEventData(e);this._publishEvent("subscription_upgrade",t)}catch(e){this._handleError(e,"reportSubscriptionUpgrade","subscription_error")}}reportSubscriptionDowngrade(e){try{this._validator.validateEventData("subscription_downgrade",e);const t=this._createEventData(e);this._publishEvent("subscription_downgrade",t)}catch(e){this._handleError(e,"reportSubscriptionDowngrade","subscription_error")}}reportSubscriptionViewed(e,t){try{const r=this._createEventData({planId:e,...t});this._validator.validateEventData("subscription_viewed",r),this._publishEvent("subscription_viewed",r)}catch(e){this._handleError(e,"reportSubscriptionViewed","subscription_error")}}getSubscriptionState(){return this._stateManager.getSubscriptionState()}_validateSubscriptionData(e){if(!e||"object"!=typeof e)throw new Error("Invalid subscription data");const t=["subscriptionId","planId","planName","amount","currency","duration","measure","status"];for(const r of t)if(!e[r])throw new Error(`Missing required field: ${r}`);if(e.metadata){const t=["trialPeriod","renewalDate","cancellationDate","paymentMethod","billingCycle","discountCode","promotionId"];for(const r of Object.keys(e.metadata))if(!t.includes(r))throw new Error(`Invalid metadata field: ${r}`)}}}class S extends v{constructor(e){super(e)}reportPaymentInitiation(e){try{this._validator.validateEventData("payment_initiation",e);const t=this._createEventData(e);this._publishEvent("payment_initiation",t)}catch(e){this._handleError(e,"reportPaymentInitiation","payment_error")}}reportPaymentCompletion(e){try{this._validator.validateEventData("payment_completion",e);const t=this._createEventData(e);this._publishEvent("payment_completion",t)}catch(e){this._handleError(e,"reportPaymentCompletion","payment_error")}}reportPaymentFailure(e){try{this._validator.validateEventData("payment_failure",e);const t=this._createEventData(e);this._publishEvent("payment_failure",t)}catch(e){this._handleError(e,"reportPaymentFailure","payment_error")}}reportPaymentRefund(e){try{this._validator.validateEventData("payment_refund",e);const t=this._createEventData(e);this._publishEvent("payment_refund",t)}catch(e){this._handleError(e,"reportPaymentRefund","payment_error")}}getPaymentState(){return this._stateManager.getPaymentState()}_validatePaymentData(e){if(!e||"object"!=typeof e)throw new Error("Invalid payment data");const t=["paymentId","amount","currency","method","status"];for(const r of t)if(!e[r])throw new Error(`Missing required field: ${r}`);if(e.metadata){const t=["transactionId","paymentProvider","paymentDate","billingAddress","shippingAddress","items","tax","discount"];for(const r of Object.keys(e.metadata))if(!t.includes(r))throw new Error(`Invalid metadata field: ${r}`)}}}class w extends v{constructor(e){super(e)}reportAdImpression(e){try{this._validator.validateEventData("ad_impression",e);const t=this._createEventData(e);this._publishEvent("ad_impression",t)}catch(e){this._handleError(e,"reportAdImpression","ad_error")}}reportAdClick(e){try{this._validator.validateEventData("ad_click",e);const t=this._createEventData(e);this._publishEvent("ad_click",t)}catch(e){this._handleError(e,"reportAdClick","ad_error")}}reportAdCompletion(e){try{this._validator.validateEventData("ad_completion",e);const t=this._createEventData(e);this._publishEvent("ad_completion",t)}catch(e){this._handleError(e,"reportAdCompletion","ad_error")}}reportAdError(e){try{this._validator.validateEventData("ad_error",e);const t=this._createEventData(e);this._publishEvent("ad_error",t)}catch(e){this._handleError(e,"reportAdError","ad_error")}}getAdState(){return this._stateManager.getAdState()}}class T extends v{constructor(e){super(e)}reportExperimentExposure(e){this._validator.validateEventData("experiment_exposure",e);const t=this._createEventData(e);this._publishEvent("experiment_exposure",t),this._logger.debug("Experiment exposure reported",t)}reportExperimentActivation(e){this._validator.validateEventData("experiment_activation",e);const t=this._createEventData(e);this._publishEvent("experiment_activation",t),this._logger.debug("Experiment activation reported",t)}}const D="VIDEO_SHARED",k="VIDEO_BOOKMARKED",x="VIDEO_LIKED",V="VIDEO_COMMENTED",P="VIDEO_RATED",R="VIDEO_QUALITY_CHANGED",A="VIDEO_PLAYBACK_SPEED_CHANGED";class C{constructor(e){this._eventQueue=e}reportUserSignUp(e,t){if(_({userId:e,metadata:t}),!t.email)throw new Error("Sign up metadata must include email");this._eventQueue.addEvent("user_sign_up",{userId:e,metadata:t,timestamp:Date.now()})}reportUserSignIn(e,t){if(_({userId:e,metadata:t}),!t.email)throw new Error("Sign in metadata must include email");this._eventQueue.addEvent("user_sign_in",{userId:e,metadata:t,timestamp:Date.now()})}reportUserSignOut(e,t){if(_({userId:e,metadata:t}),!t.email)throw new Error("Sign out metadata must include email");this._eventQueue.addEvent("user_sign_out",{userId:e,metadata:t,timestamp:Date.now()})}reportUserProfileUpdate(e,t){if(_({userId:e,data:t}),!t.updatedFields||!Array.isArray(t.updatedFields))throw new Error("Profile update data must include updatedFields array");this._eventQueue.addEvent("user_profile_update",{userId:e,...t,timestamp:Date.now()})}}class N{constructor(e){this._eventQueue=e}reportFeatureUsage(e){_({featureId:e.featureId,featureName:e.featureName,action:e.action});const t={type:"feature_usage",data:{featureId:e.featureId,featureName:e.featureName,action:e.action,metadata:e.metadata||{},timestamp:Date.now()}};this._eventQueue.addEvent(t)}}class U extends v{constructor(e){super(e)}reportUserInteraction(e){try{this._validator.validateEventData("user_interaction",e);const t=this._createEventData(e);this._publishEvent("user_interaction",t),this._logger.debug("User interaction reported",t)}catch(e){this._handleError(e,"reportUserInteraction","user_interaction_error")}}reportUserPreference(e){try{this._validator.validateEventData("user_preference",e);const t=this._createEventData(e);this._publishEvent("user_preference",t),this._logger.debug("User preference reported",t)}catch(e){this._handleError(e,"reportUserPreference","user_preference_error")}}reportUserFeedback(e){try{this._validator.validateEventData("user_feedback",e);const t=this._createEventData(e);this._publishEvent("user_feedback",t),this._logger.debug("User feedback reported",t)}catch(e){this._handleError(e,"reportUserFeedback","user_feedback_error")}}reportUserClick(e){try{this._validator.validateEventData("user_click",e);const t=this._createEventData(e);this._publishEvent("user_click",t),this._logger.debug("User click reported",t)}catch(e){this._handleError(e,"reportUserClick","user_click_error")}}reportUserScroll(e){try{this._validator.validateEventData("user_scroll",e);const t=this._createEventData(e);this._publishEvent("user_scroll",t),this._logger.debug("User scroll reported",t)}catch(e){this._handleError(e,"reportUserScroll","user_scroll_error")}}}class H extends v{constructor(e){super(e)}reportVideoShared(e,t){try{if(!e||"string"!=typeof e)throw new Error("assetId must be a string");if(!t||"object"!=typeof t)throw new Error("metadata must be an object");const r=this._createEventData({type:D,assetId:e,...t,timestamp:Date.now()});this._validator.validateEventData(D,r),this._publishEvent(D,r),this._logger.debug("Video shared reported",r)}catch(e){this._handleError(e,"reportVideoShared","video_engagement_error")}}reportVideoBookmarked(e){try{this._validator.validateEventData(k,e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent(k,t),this._logger.debug("Video bookmarked reported",t)}catch(e){this._handleError(e,"reportVideoBookmarked","video_engagement_error")}}reportVideoLiked(e){try{this._validator.validateEventData(x,e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent(x,t),this._logger.debug("Video liked reported",t)}catch(e){this._handleError(e,"reportVideoLiked","video_engagement_error")}}reportVideoComment(e){try{this._validator.validateEventData(V,e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent(V,t),this._logger.debug("Video comment reported",t)}catch(e){this._handleError(e,"reportVideoComment","video_engagement_error")}}reportVideoRating(e){try{this._validator.validateEventData(P,e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent(P,t),this._logger.debug("Video rating reported",t)}catch(e){this._handleError(e,"reportVideoRating","video_engagement_error")}}reportVideoQualityChange(e){try{this._validator.validateEventData(R,e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent(R,t),this._logger.debug("Video quality change reported",t)}catch(e){this._handleError(e,"reportVideoQualityChange","video_engagement_error")}}reportVideoPlaybackSpeedChange(e){try{this._validator.validateEventData(A,e);const t=this._createEventData({...e,timestamp:Date.now()});this._publishEvent(A,t),this._logger.debug("Video playback speed change reported",t)}catch(e){this._handleError(e,"reportVideoPlaybackSpeedChange","video_engagement_error")}}reportCustomEngagement(e,t){try{this._validator.validateEventData(e,t);const r=this._createEventData(t);this._publishEvent(e,r),this._logger.debug(`Custom video engagement reported: ${e}`,r)}catch(e){this._handleError(e,"reportCustomEngagement","video_engagement_error")}}}return e.Config=t,e.ErrorHandler=n,e.EventPublisher=s,e.EventQueue=a,e.Logger=c,e.MMAppAnalyticsSDK=class{constructor(){this._version="1.0.0",this._isInitialized=!1,this._initializationInProgress=!1,this._registrationRetryCount=2,this._config=null,this._stateManager=null,this._eventQueue=null,this._eventPublisher=null,this._errorHandler=null,this._logger=null,this._validator=null,this._videoTracker=null,this._screenTracker=null,this._appTracker=null,this._userTracker=null,this._autoCollection=null,this._subscriptionTracker=null,this._paymentTracker=null,this._adTracker=null,this._experimentTracker=null,this._userAuthTracker=null,this._featureUsageTracker=null,this._userInteractionTracker=null,this._videoEngagementTracker=null}async initialize(e,i,o,d,l={},h={}){try{if(this._isInitialized)return void this._logger?.warn("SDK already initialized");if(this._initializationInProgress)return void this._logger?.warn("SDK initialization in progress");this._validateInitParams(e,i,o,d),this._initializationInProgress=!0,this._config=new t({customerId:e,appId:i,appName:o,appVersion:d,...h}),this._stateManager=new r,this._eventQueue=new a(this._config),this._eventPublisher=new s(this._eventQueue,this._config),this._errorHandler=new n(this._config),this._logger=new c(this._config),this._validator=new g(this._config);const u={customerId:e,appId:i,appName:o,appVersion:d,sdkVersion:this._config.sdkVersion,sessionId:this._config.sessionId,screenRes:this._getScreenResolution(),timestamp:Date.now(),custId:e,subscriberId:l.subscriberId||"",subscriberType:l.subscriberType||"",subscriberTag:l.subscriberTag||"",clientInfo:{appName:o,appVersion:d,scrnRes:this._getScreenResolution(),ua:this._config.get("userAgent")||""},userInfo:{profileId:l.profileId||"",userData:l.userData||{},referralId:l.referralId||"",referralData:l.referralData||{}},customTags:l.customTags||{}};this._eventPublisher.updateCurrentPayload(u);const p={config:this._config,eventPublisher:this._eventPublisher,logger:this._logger,validator:this._validator,errorHandler:this._errorHandler,stateManager:this._stateManager};this._videoTracker=new m(p),this._screenTracker=new f(p),this._appTracker=new y(p),this._userTracker=new E(p),this._userInteractionTracker=new U(p),this._videoEngagementTracker=new H(p),this._autoCollection=new b(this._config,this._logger,this._eventPublisher),this._autoCollection.setEnabled(h.autoCollect??!0),this._subscriptionTracker=new I(p),this._paymentTracker=new S(p),this._adTracker=new w(p),this._experimentTracker=new T(p),this._userAuthTracker=new C(p),this._featureUsageTracker=new N(p);try{const t=await this._registerWithBackend(e);this._eventPublisher.setProducerURL(t.producerURL||"https://streamproducer-lcrr.mediamelon.com"),this._eventPublisher.setStatsInterval(t.statsInterval)}catch(t){if(this._registrationRetryCount>0)return this._registrationRetryCount--,this._initializationInProgress=!1,void await this.initialize(e,i,o,d,l,h);throw t}this._isInitialized=!0,this._initializationInProgress=!1,this._logger.debug("SDK initialized successfully");const _=[];_.push({type:"app_state",data:{type:"app_state",customerId:e,appId:i,appName:o,appVersion:d,state:"foreground",timestamp:Date.now(),sessionId:this._config.sessionId,sdkVersion:this._config.sdkVersion,screenRes:this._getScreenResolution(),custId:e,subscriberId:l.subscriberId||"",subscriberType:l.subscriberType||"",subscriberTag:l.subscriberTag||"",clientInfo:{appName:o,appVersion:d,scrnRes:this._getScreenResolution(),ua:this._config.get("userAgent")||""},userInfo:{profileId:l.profileId||"",userData:l.userData||{},referralId:l.referralId||"",referralData:l.referralData||{}},customTags:l.customTags||{}}}),l&&Object.keys(l).length>0&&_.push({type:"user_identification",data:{type:"user_identification",customerId:e,appId:i,appName:o,appVersion:d,timestamp:Date.now(),sessionId:this._config.sessionId,sdkVersion:this._config.sdkVersion,screenRes:this._getScreenResolution(),custId:e,subscriberId:l.subscriberId||"",subscriberType:l.subscriberType||"",subscriberTag:l.subscriberTag||"",clientInfo:{appName:o,appVersion:d,scrnRes:this._getScreenResolution(),ua:this._config.get("userAgent")||""},userInfo:{profileId:l.profileId||"",userData:l.userData||{},referralId:l.referralId||"",referralData:l.referralData||{}},customTags:l.customTags||{}}}),_.push({type:"SESSION_START",data:{type:"session_start",customerId:e,appId:i,appName:o,appVersion:d,timestamp:Date.now(),sessionId:this._config.sessionId,sdkVersion:this._config.sdkVersion,screenRes:this._getScreenResolution(),custId:e,subscriberId:l.subscriberId||"",subscriberType:l.subscriberType||"",subscriberTag:l.subscriberTag||"",clientInfo:{appName:o,appVersion:d,scrnRes:this._getScreenResolution(),ua:this._config.get("userAgent")||""},userInfo:{profileId:l.profileId||"",userData:l.userData||{},referralId:l.referralId||"",referralData:l.referralData||{}},customTags:l.customTags||{}}}),this._config.get("userAgent"),_.forEach((e=>{this._eventPublisher.publishEvent(e.type,e.data)})),this._eventPublisher.startSendingHeartBeatPayload()}catch(e){throw this._initializationInProgress=!1,this._handleError(e,"initialize"),e}}isInitialized(){return!0===this._isInitialized}destroy(){if(this._isInitialized)try{this._sendEvent("SESSION_END",{timestamp:Date.now(),sessionId:this._config?.sessionId,isGraceful:!0}),this._sendEvent("sdk_shutdown",{timestamp:Date.now()}),this._eventQueue&&this._eventQueue.destroy(),this._stateManager&&this._stateManager.clearStates(),this._logger&&this._logger.info("SDK destroyed"),this._isInitialized=!1,this._config=null,this._stateManager=null,this._eventQueue=null,this._errorHandler=null,this._logger=null,this._validator=null}catch(e){this._logger?this._logger.error("Error during SDK destruction:",e):console.error("Error during SDK destruction:",e)}}reportVideoState(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid video state data");this._validator.validateEventData("video_state",e);const t=this._stateManager.getVideoState();this._validator.validateStateTransition(t,e.state,"video"),this._stateManager.updateVideoState(e.state,e)&&this._sendEvent("video_state",e)}catch(e){throw this._handleError(e,"reportVideoState"),e}}reportScreenView(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid screen view data");this._validator.validateEventData("screen_view",e),this._screenTracker.reportScreenView(e)}catch(e){throw this._handleError(e,"reportScreenView"),e}}reportAppState(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid app state data");this._validator.validateEventData("app_state",e),this._appTracker.reportAppState(e)}catch(e){throw this._handleError(e,"reportAppState"),e}}reportAppError(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid error data");this._validator.validateEventData("app_error",e),this._appTracker.reportAppError(e)}catch(e){throw this._handleError(e,"reportAppError"),e}}reportUserInfo(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid user info data");this._validator.validateEventData("user_info",e),this._logger&&this._logger.setUserId(e.userId),this._sendEvent("user_info",e)}catch(e){throw this._handleError(e,"reportUserInfo"),e}}reportEvent(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid event data");this._validator.validateEventData(e.type||"custom",e),this._sendEvent(e.type||"custom",e)}catch(e){throw this._handleError(e,"reportEvent"),e}}getStatus(){return{version:this._version,isInitialized:this._isInitialized,config:this._config?.getConfig(),eventQueue:this._eventQueue?.getStatus()}}onError(e,t){this._validateInitialization(),this._errorHandler.onError(e,t)}getErrorHistory(){return this._validateInitialization(),this._errorHandler.getErrorHistory()}clearErrorHistory(){this._validateInitialization(),this._errorHandler.clearErrorHistory()}setLogLevel(e){this._validateInitialization(),this._logger.setLogLevel(e)}setLoggingEnabled(e){this._validateInitialization(),this._logger.setEnabled(e)}onLog(e,t){this._validateInitialization(),this._logger.onLog(e,t)}getLogHistory(){return this._validateInitialization(),this._logger.getLogHistory()}clearLogHistory(){this._validateInitialization(),this._logger.clearLogHistory()}getPerformanceMetrics(){return this._validateInitialization(),{eventQueue:this._eventQueue?this._eventQueue.getStatus():{queueLength:0,successfulEvents:0,failedEvents:0,processingTime:0},timestamp:Date.now()}}getSessionInfo(){return this._autoCollection.getSessionInfo()}getNavigationInfo(){return this._autoCollection.getNavigationInfo()}setAutoCollectionEnabled(e){this._autoCollection.setEnabled(e),this._logger.debug("Auto-collection "+(e?"enabled":"disabled"))}_validateInitialization(){if(!this._isInitialized)throw new Error("SDK not initialized")}_generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}async _registerWithBackend(e){const t=`https://register.mediamelon.com/mm-apis/register/${e}?platform=Browser&component=HTML5JSSDK`;return new Promise(((e,r)=>{const i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){if(i.status>=200&&i.status<300)try{const t=JSON.parse(i.responseText);e(t)}catch(e){r(new Error("Invalid registration response"))}else r(new Error(`Registration failed with status: ${i.status}`))},i.onerror=function(){r(new Error("Registration request failed"))},i.send()}))}_sendEvent(e,t){if(!this._eventQueue)throw new Error("Event queue not initialized");this._eventPublisher.publishEvent(e,t)}_handleError(e,t,r={}){this._logger&&this._logger.error(`Error in ${t}:`,e),this._errorHandler&&this._errorHandler.handleError(e,t,r),this._eventQueue&&this._isInitialized&&this._sendEvent("sdk_error",{context:t,error:{name:e.name,message:e.message,stack:e.stack},metadata:r})}_validateInitParams(e,t,r,i){if(!e||"string"!=typeof e)throw new Error("Invalid customer ID");if(!t||"string"!=typeof t)throw new Error("Invalid application ID");if(!r||"string"!=typeof r)throw new Error("Invalid application name");if(!i||"string"!=typeof i)throw new Error("Invalid application version")}reportVideoStart(e){this._validateInitialization();try{if(JSON.stringify(e),!e||"object"!=typeof e)throw new Error("Invalid video start data");this._validator.validateEventData("video_start",e),this._videoTracker.reportVideoStart(e)}catch(e){throw this._handleError(e,"reportVideoStart"),e}}reportVideoPause(e){return this._videoTracker.reportVideoPause(e)}reportVideoResume(e){return this._videoTracker.reportVideoResume(e)}reportVideoSkip(e){return this._videoTracker.reportVideoSkip(e)}reportVideoStop(e){return this._videoTracker.reportVideoStop(e)}reportVideoEnd(e){return this._videoTracker.reportVideoEnd(e)}reportVideoQuality(e){return this._validateInitialization(),this._videoTracker.reportVideoQualityChange(e)}reportVideoBuffering(e){return this._videoTracker.reportVideoBuffering(e)}reportScreenExit(e){return this._screenTracker.reportScreenExit(e)}reportPerformanceMetrics(e){return this._appTracker.reportPerformanceMetrics(e)}reportUserIdentification(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid user identification data");this._validator.validateEventData("user_identification",e),this._userTracker.reportUserIdentification(e)}catch(e){throw this._handleError(e,"reportUserIdentification"),e}}reportUserSessionStart(e){return this._userTracker.reportUserSessionStart(e)}reportUserSessionEnd(e){return this._userTracker.reportUserSessionEnd(e)}reportUserPreferenceChange(e){return this._userTracker.reportUserPreferenceChange(e)}getVideoState(){return this._videoTracker.getVideoState()}getScreenState(){return this._screenTracker.getScreenState()}getAppState(){return this._appTracker.getAppState()}getUserState(){return this._userTracker.getUserState()}reportSubscriptionStart(e){return this._subscriptionTracker.reportSubscriptionStart(e)}reportSubscriptionRenewal(e){return this._subscriptionTracker.reportSubscriptionRenewal(e)}reportSubscriptionCancellation(e){return this._subscriptionTracker.reportSubscriptionCancellation(e)}reportSubscriptionUpgrade(e){return this._subscriptionTracker.reportSubscriptionUpgrade(e)}reportSubscriptionDowngrade(e){return this._subscriptionTracker.reportSubscriptionDowngrade(e)}reportPaymentInitiation(e){return this._paymentTracker.reportPaymentInitiation(e)}reportPaymentSuccess(e){return this._paymentTracker.reportPaymentSuccess(e)}reportPaymentFailure(e){return this._paymentTracker.reportPaymentFailure(e)}reportPaymentRefund(e){return this._paymentTracker.reportPaymentRefund(e)}reportAdImpression(e){return this._adTracker.reportAdImpression(e)}reportAdClick(e){return this._adTracker.reportAdClick(e)}reportAdStart(e){return this._adTracker.reportAdStart(e)}reportAdComplete(e){return this._adTracker.reportAdComplete(e)}reportAdSkip(e){return this._adTracker.reportAdSkip(e)}reportAdError(e){return this._adTracker.reportAdError(e)}getSubscriptionState(){return this._subscriptionTracker.getSubscriptionState()}getPaymentState(){return this._paymentTracker.getPaymentState()}getAdState(){return this._adTracker.getAdState()}reportExperimentExposure(e){return this._experimentTracker.reportExperimentExposure(e)}reportExperimentActivation(e){return this._experimentTracker.reportExperimentActivation(e)}reportFeatureFlagEvaluation(e){return this._experimentTracker.reportFeatureFlagEvaluation(e)}reportExperimentResults(e){return this._experimentTracker.reportExperimentResults(e)}getExperimentState(e){return this._experimentTracker.getExperimentState(e)}getActiveExperiments(){return this._experimentTracker.getActiveExperiments()}reportUserProfileUpdate(e,t){this._userAuthTracker.reportUserProfileUpdate(e,t)}reportFeatureUsage(e){this._validateInitialization();try{this._featureUsageTracker.reportFeatureUsage(e)}catch(e){throw this._handleError(e,"reportFeatureUsage"),e}}reportSubscriptionViewed(e,t){this._subscriptionTracker.reportSubscriptionViewed(e,t)}reportUserClick(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid click metadata");this._userInteractionTracker.reportUserClick(e)}catch(e){throw this._handleError(e,"reportUserClick"),e}}reportUserScroll(e){this._validateInitialization();try{if(!e||"object"!=typeof e)throw new Error("Invalid scroll metadata");this._userInteractionTracker.reportUserScroll(e)}catch(e){throw this._handleError(e,"reportUserScroll"),e}}reportVideoShared(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoShared(e,t)}reportVideoBookmarked(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoBookmarked(e,t)}reportVideoLiked(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoLiked(e,t)}reportVideoComment(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoComment(e,t)}reportVideoRating(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoRating(e,t)}reportVideoQualityChange(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoQualityChange(e,t)}reportVideoPlaybackSpeedChange(e,t){return this._validateInitialization(),this._videoEngagementTracker.reportVideoPlaybackSpeedChange(e,t)}_createEvent(e,t){return{type:e,data:t,timestamp:Date.now(),sessionId:this._config.getSessionId(),config:this._config.getConfig(),metadata:this._config.getEventMetadata()}}_initializeSession(){const e=this._config.getSessionId();return this._config.updateSessionId(e),e}_getScreenResolution(){return"undefined"!=typeof window&&window.screen?`${window.screen.width}x${window.screen.height}`:""}},e.StateManager=r,e.Validator=g,e}({});
//# sourceMappingURL=mm-app-analytics-js-sdk.min.js.map
